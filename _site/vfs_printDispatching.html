<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Every evening, the VFS Print Dispatching System executes.  It is looking for any job in a 'Rendered' status and gathers them up and submits them to the Vendo...">
<meta name="keywords" content="vfsservicerpc,  rpc, Print Dispatching, dispatch, vendor dispatch, vendor, engine, Amazing Mail, VFS_Job_VendorDispatch_AM, throttling, vfs, service">
<title>Print Dispatching | Velma Site Documentation</title>
<link rel="stylesheet" href="css/syntax.css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/boxshadowproperties.css">
<!-- most color styles are extracted out to here -->
<link rel="stylesheet" href="css/theme-green.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<!-- Anchor.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="twain" href="http://localhost:4000/feed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    <script>
        $(document).ready(function() {
            $("#tg-sb-link").click(function() {
                $("#tg-sb-sidebar").toggle();
                $("#tg-sb-content").toggleClass('col-md-9');
                $("#tg-sb-content").toggleClass('col-md-12');
                $("#tg-sb-icon").toggleClass('fa-toggle-on');
                $("#tg-sb-icon").toggleClass('fa-toggle-off');
            });
        });
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-static-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Velma Site Documentation</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- toggle sidebar button -->
                <li><a id="tg-sb-link" href="#"><i id="tg-sb-icon" class="fa fa-toggle-on"></i> Nav</a></li>
                <!-- entries without drop-downs appear here -->




                
                
                
                <li><a href="news">News</a></li>
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Products<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="mydoc_docs_fonts.html">Velma Site Documentation</a></li>
                        
                        
                        
                        <li><a href="p1_landing_page.html">VFS</a></li>
                        
                        
                        
                        <li><a href="p2_landing_page.html">Documentation Guide</a></li>
                        
                        
                        
                        <li><a href="http://build.velma.com/api/swagger/ui/index#/" target="_blank">Velma API (v4)</a></li>
                        
                        
                        
                        <li><a href="http://readme.velma.com/" target="_blank">VFS API documentation</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
			<li>



  <a class="email" title="Submit feedback" href="#" onclick="javascript:window.location='mailto:nathan.nordby@gmail.com?subject=Velma Site Documentation feedback&body=I have some feedback about the Print Dispatching page: ' + window.location.href;"><i class="fa fa-envelope-o"></i> Feedback</a>

</li>

		
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Print Dispatching">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
  <div id="main">
    <!-- Content Row -->
    <div class="row">
        
        
            <!-- Sidebar Column -->
            <div class="col-md-3" id="tg-sb-sidebar">
                

<ul id="mysidebar" class="nav">
  <li class="sidebarTitle">VFS 1.0</li>
  
  
  
      
  
  <li>
      <a href="#">Services</a>
      <ul>
          
          
          
          <li><a href="vfs_productService.html">RPC Product Service</a></li>
          
          
          
          
          
          
          <li class="active"><a href="vfs_printDispatching.html">Print Dispatching</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Getting Started</a>
      <ul>
          
          
          
          <li><a href="p1_landing_page.html">Product 1 home</a></li>
          
          
          
          
          
          
          <li><a href="p1_sample1.html">Sample 1</a></li>
          
          
          
          
          
          
          <li><a href="p1_sample2.html">Sample 2</a></li>
          
          
          
          
          
          
          <li><a href="p1_sample3.html">Sample 3</a></li>
          
          
          
          
      </ul>
   </li>
     
      
  
  <li>
      <a href="#">Another heading</a>
      <ul>
          
          
          
          <li><a href="p1_sample4.html">Sample 4</a></li>
          
          
          
          
          
          
          <li><a href="p1_sample5.html">Sample 5</a></li>
          
          
          
          
          
          
          <li><a href="p1_sample6.html">Sample 6</a></li>
          
          
          
          
          
          
          <li><a href="p1_sample7.html">Sample 7</a></li>
          
          
          
          
      </ul>
   </li>
     
      
      
      <!-- if you aren't using the accordion, uncomment this block:
         <p class="external">
             <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
         </p>
         -->
</ul>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

            </div>
            
        

        <!-- Content Column -->
        <div class="col-md-9" id="tg-sb-content">
            <div class="post-header">
   <h1 class="post-title-main">Print Dispatching</h1>
</div>



<div class="post-content">

   
    <div class="summary">Every evening, the VFS Print Dispatching System executes.  It is looking for any job in a 'Rendered' status and gathers them up and submits them to the Vendor Engine for processing. After dispatching, the job gets set to 'Dispatched' status.  When the job is on its way to Amazing Mail, the status is set to 'Sending'. This is how it works.</div>
   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    


    

    <a target="_blank" href="https://github.com/nnordby/twain/blob/gh-pages/pages/product1/vfs_printDispatching.md" class="btn btn-default githubEditButton" role="button"><i class="fa fa-github fa-lg"></i> Edit me</a>

    


    

  <h3 id="admin-web">Admin Web</h3>
<p><strong>To query jobs to be dispatched:</strong></p>
<ul>
  <li>Select <strong>‘Velma’</strong> from the Sponsor filter drop down (if not already selected)</li>
  <li>Select <strong>‘Rendered’</strong> from the Status filter drop down</li>
  <li>Date Filter - select <strong>Custom Range</strong> and look back a few days</li>
</ul>

<p><strong>To query jobs that are currently being re-queued or in a dispatched state.</strong></p>
<ul>
  <li>Select <strong>‘Velma’</strong> from the Sponsor filter drop down (if not already selected)</li>
  <li>Select <strong>‘Dispatched’</strong> from the Status filter drop down</li>
  <li>Date Filter - select <strong>Custom Range</strong> and look back a few days</li>
  <li>Anything in a dispatched state is currently going through processing to print Vendor.</li>
</ul>

<p><strong>To query jobs that are currently being sent to Amazing Mail:</strong></p>
<ul>
  <li>Select <strong>‘Velma’</strong> from the Sponsor filter drop down (if not already selected)</li>
  <li>
    <ul>
      <li>Select <strong>‘Sending’</strong> from the Status filter drop down</li>
    </ul>
  </li>
  <li>Date Filter - select <strong>Custom Range</strong> and look back a few days</li>
</ul>

<h4 id="detailed-workflow">Detailed Workflow</h4>
<p><img src="https://helpdesk.velma.com/NSN-Documentation/VFS/Workflow_PrintDispatching.png" alt="Vendor Dispatch" /></p>

<h3 id="technologies">Technologies</h3>
<h5 id="figure-1">Figure 1</h5>
<p><img src="https://helpdesk.velma.com/NSN-Documentation/VFS/AWS_CloudWatch_Rules.png" alt="Rules" /></p>
<h5 id="figure-2">Figure 2</h5>
<p><img src="https://helpdesk.velma.com/NSN-Documentation/VFS/AWS_CloudWatch_Rules_Rule.png" alt="Rules Actions" /></p>
<h5 id="figure-3">Figure 3</h5>
<p><img src="https://helpdesk.velma.com/NSN-Documentation/VFS/AWS_CloudWatch_Rule_Details_RuleDetails.png" alt="Create Rule" /></p>

<h3 id="aws-lambda-vfs_job_vendordispatch_am">AWS Lambda (VFS_Job_VendorDispatch_AM)</h3>
<ul>
  <li>This lambda does the following:
    <ul>
      <li>Queries Dynamo for jobs in a ‘Rendered’ status</li>
      <li>Once it gathers a list of those jobs, it iterates through them one by one doing the following:
        <ul>
          <li>For each job, it gets the job’s command packet using the Dynamo item.cp_ref property</li>
          <li>It then dispatches that job
            <ul>
              <li>Dispatching Means:
                <ul>
                  <li>Set the job status to ‘Dispatched’</li>
                  <li>Drop the command packet in the SQS (VFS_Print_Vendor_AmazingMail) Queue</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>The Amazing Mail Vendor Engine reads from that Queue</li>
    </ul>
  </li>
</ul>

<h3 id="vfs-amazing-mail-vendor-engine">VFS Amazing Mail Vendor Engine</h3>
<ul>
  <li>The engine does the following:
    <ul>
      <li>Polls the VFS_Print_Vendor_AmazingMail Queue for jobs</li>
      <li>Grabs a job in the form of a command packet (Also called a task) and starts to process it</li>
      <li>Checks throttling logic (Explained below)</li>
      <li>Submits the job to Amazing Mail for printing</li>
    </ul>
  </li>
</ul>

<h3 id="throttling-explained">Throttling Explained</h3>
<ul>
  <li>Due to VFS submitting jobs to Amazing Mail too fast we had to implement throttling</li>
  <li>How throttling works (it is based on a few values):
    <ul>
      <li>Throttling Interval
        <ul>
          <li>Throttle a job for ‘X’ seconds</li>
          <li>Current Value = 60 Seconds</li>
          <li>Located in the Engine Code (Private const THROTTLE_INTERVAL)</li>
        </ul>
      </li>
      <li>Throttling Limit
        <ul>
          <li>Only send ‘X’ at a time to the vendor Amazing Mail</li>
          <li>Current Value = 5</li>
          <li>Located in ETCD (etcdctl get /config/services/VFS.Engines/Vendor/throttleLimit/amazingmail)</li>
        </ul>
      </li>
      <li>Re-queueing Delay
        <ul>
          <li>A calculated value indicating a delay for dropping the job back in the queue</li>
          <li>So a job gets dropped back into the queue but doesn’t show up for X seconds</li>
          <li>Current Value = 60 seconds</li>
          <li>Located in Vendor Engine Vendor Service isOverLimit function</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>The simple explanation is:
    <ul>
      <li>Throttling allows us to only 5 jobs every 60 seconds to Amazing Mail</li>
      <li>A list of jobs to be sent is created in REDIS and that list is check by the Vendor Engine</li>
      <li>If the next job makes the list of of jobs bigger than 5 within 60 seconds that job will be re-queued</li>
      <li>There is a 60 second delay on the re-queue</li>
      <li>So if we have a 1000 jobs to send - at the throttled rate of 5 jobs per 60 seconds then it will take 3 hours to send those (UGGH)</li>
    </ul>
  </li>
  <li>The detailed explanation is:
    <ul>
      <li>The Vendor Engine keeps a list (REDIS) of the last few jobs sorted by the dispatched date
        <ul>
          <li>List:
            <ul>
              <li>Job 1: 2017-01-01:6:00 PM - Will last 60 Secs</li>
              <li>Job 1: 2017-01-01:6:03 PM - Will last 60 Secs</li>
              <li>Job 1: 2017-01-01:6:05 PM - Will last 60 Secs</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>If the number of items in the list is &gt; the 5 jobs / 60 secs the job will be re-queued with a 60 second delay</li>
      <li>If the number of items in the list is &lt; the 5 jobs / 60 secs the job is added to the list and dispatched</li>
      <li>The size of the list will grow each time a job is dispatched and shrink each time a record in the list expires</li>
      <li>The expiry time is 60 seconds (each redis record will go away in 60 secs)</li>
      <li>The number of jobs Amazing Mail can handle is 5 / 60 Secs</li>
      <li>Therefore if there is a batch of 1000
        <ul>
          <li>VFS will send 5 every minute</li>
          <li>It will take 3 hrs to process all 1000 jobs</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>



    <div class="tags">
        
        <b>Tags: </b>
        
        
        
        <a href="tag_vfs.html" class="btn btn-default navbar-btn cursorNorm" role="button">vfs</a>
        
        
        
        <a href="tag_service.html" class="btn btn-default navbar-btn cursorNorm" role="button">service</a>
        
        
        
        <a href="tag_rpc.html" class="btn btn-default navbar-btn cursorNorm" role="button">rpc</a>
        
        
        
    </div>




</div>

<hr class="shaded"/>

<footer>
  <div class="row">
    <div class="col-lg-12 footer">
      &copy;2018 NSN Solutions, Inc.. All rights reserved. <br /> <span>Page last updated:</span> February 23, 2018<br/> Site last generated: Mar 19, 2018 <br />This
      document is proprietary and confidential. No part of this document may be disclosed in any manner <br />without the prior written consent of NSN Solutions, Inc..
      <p><img class="logo_footer" src=" images/company_logo.png " alt="Company logo" /></p>
    </div>
  </div>
</footer>

        </div>
    <!-- /.row -->
</div>
<!-- /.container -->
</div>
<!-- /#main -->
    </div>

</body>

</html>
